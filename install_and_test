#!/bin/sh

make clean;
make;
sudo make install;

psql <<EOF
	SET jit=on;
	--SET work_mem="1MB";
	DROP EXTENSION repeat;
	CREATE EXTENSION repeat;

	\timing
	\echo ValuePerCall
	SELECT * FROM repeat_valuepercall(7,7);
	\echo Materialize
	SELECT * FROM repeat_materialize(7,7);
	\echo
	\echo

	\set RS_SIZE 100000
	
	\echo ValuePerCall
	SELECT count(*) FROM (SELECT repeat_valuepercall(7,:RS_SIZE)) s;
	\echo
	\echo

	\echo Materialize
	SELECT count(*) FROM (SELECT repeat_materialize(7,:RS_SIZE)) s;
	\echo
	\echo
	
	\echo ValuePerCall
	SELECT count(*) FROM (SELECT * FROM repeat_valuepercall(7,:RS_SIZE)) s;
	\echo
	\echo

	\echo Materialize
	SELECT count(*) FROM (SELECT * FROM repeat_materialize(7,:RS_SIZE)) s;
	\echo
	\echo
	
	\echo ValuePerCall
	SELECT count(*) FROM repeat_valuepercall(7,:RS_SIZE) s;
	\echo
	\echo

	\echo Materialize
	SELECT count(*) FROM repeat_materialize(7,:RS_SIZE) s;
	\echo
	\echo
EOF
